<?php/*	admin_explorer	File Explorer	Ultima modifica 7/3/13 (v0.6.1)*/include('_data/privileges.php');if ($user['level'] <= $__privileges['explorer_access']) {	include('_proto/explorer.php');	include('_proto/func.php');	include("lang/$__lang/a_explorer.php");	//Controllo che azione mi è richiesta di eseguire	if (isset($_POST['act']))		$action = $_POST['act'];	else		$action = (isset($_GET['act'])) ? $_GET['act'] : 'none';	if ($action != 'none')		switch ($action) {			case 'shell' :				//Shell				if ($user['level'] <= $__privileges['explorer_shell']) {					if (isset($_GET['com']))					{						//Esecuzione di un commando						$inutilizzabili = @ini_get("disable_functions");						if (!empty($inutilizzabili))						{							$inutilizzabili = str_replace(" ","",$inutilizzabili);							$inutilizzabili = explode(",",$inutilizzabili);						}						if ($_GET['com'] != '')						{							if (is_callable("exec") and !@in_array("exec",$inutilizzabili)) 							{								exec($_GET['com'],$result); 								echo nl2br(htmlspecialchars(join("\n",$result)));							}							else 							if (($result = `$cmd`) !== false) {}							else							if (is_callable("system") and !@in_array("system",$inutilizzabili)) 							{								@ob_clean(); 								system($_GET['com']); 								echo nl2br(htmlspecialchars(@ob_get_contents())); 								@ob_clean(); 							}							else							if (is_callable("passthru") and !@in_array("passthru",$inutilizzabili)) 							{								@ob_clean(); 								passthru($_GET['com']); 								echo nl2br(htmlspecialchars(@ob_get_contents())); 								@ob_clean();							}							else							if (is_resource($fp = popen($_GET['com'],"r")))							{								while(!feof($fp)) echo nl2br(htmlspecialchars(fread($fp,1024)));								pclose($fp);							}							else								echo 'ERROR!!!';						}					}					//Mostro la shell					echo "		<style>body {background:black;color:white;font-family: monospace;}</style>		<form action='admin_explorer.html' method='get'>		<input type='hidden' name='act' value='shell'>		<input class='textbox' style='width:100%' type='text' name='com'><input class='button' type='submit' value='$__exec'>		</form>";					exit(0);				}			break;				case 'chmod' :				//Cambio di permessi				if ($user['level'] <= $__privileges['explorer_chmod']) {					if (isset($_GET['change']))	{						//Salvataggio nuovi permessi						$mode = 0000;						if ((isset($_GET['ur']))&&($_GET['ur'] == 'on')) $mode += 0400;						if ((isset($_GET['uw']))&&($_GET['uw'] == 'on')) $mode += 0200;						if ((isset($_GET['ux']))&&($_GET['ux'] == 'on')) $mode += 0100;      						if ((isset($_GET['gr']))&&($_GET['gr'] == 'on')) $mode += 040;						if ((isset($_GET['gw']))&&($_GET['gw'] == 'on')) $mode += 020;						if ((isset($_GET['gx']))&&($_GET['gx'] == 'on')) $mode += 010;						if ((isset($_GET['ar']))&&($_GET['ar'] == 'on')) $mode += 04;						if ((isset($_GET['aw']))&&($_GET['aw'] == 'on')) $mode += 02;						if ((isset($_GET['ax']))&&($_GET['ax'] == 'on')) $mode += 01;						foreach ($_GET['f'] as $f)							chmod($f,$mode);						//Chiusura automatica finestra						echo 'OK!<script>setTimeout ( "parent.close_win()", 500 );</script>';					} else {						//Mostro la tabella dei permessi						$perms = fileperms($_GET['f'][0]);						$ur = (($perms & 0x0100) ? 'checked' : '');						$uw = (($perms & 0x0080) ? 'checked' : '');						$ux = (($perms & 0x0040) ?							(($perms & 0x0800) ? '' : 'checked' ) :							(($perms & 0x0800) ? '' : ''));						$gr = (($perms & 0x0020) ? 'checked' : '');						$gw = (($perms & 0x0010) ? 'checked' : '');						$gx = (($perms & 0x0008) ?							(($perms & 0x0400) ? '' : 'checked' ) :							(($perms & 0x0400) ? '' : ''));						$ar = (($perms & 0x0004) ? 'checked' : '');						$aw = (($perms & 0x0002) ? 'checked' : '');						$ax = (($perms & 0x0001) ?							(($perms & 0x0200) ? '' : 'checked' ) :							(($perms & 0x0200) ? '' : ''));						echo "<form action='admin_explorer.html' method='get'><Table border='1'><TR><TD><TD>$__ch_usr<TD>$__ch_grp<TD>$__ch_all<TR><TD>$__ch_read<TD><center><input class='checkbox' type='checkbox' name='ur' $ur><TD><center><input class='checkbox' type='checkbox' name='gr' $gr><TD><center><input class='checkbox' type='checkbox' name='ar' $ar><TR><TD>$__ch_write<TD><center><input class='checkbox' type='checkbox' name='uw' $uw><TD><center><input class='checkbox' type='checkbox' name='gw' $gw><TD><center><input class='checkbox' type='checkbox' name='aw' $aw><TR><TD>$__ch_exec<TD><center><input class='checkbox' type='checkbox' name='ux' $ux><TD><center><input class='checkbox' type='checkbox' name='gx' $gx><TD><center><input class='checkbox' type='checkbox' name='ax' $ax></TABLE><input type='hidden' name='act' value='chmod'><input type='hidden' name='change'>";						foreach ($_GET['f'] as $f)	echo "<input type='hidden' name='f[]' value='$f'>";						echo "<input class='button' type='submit' value='$__change'>		</form>";					}							exit (0);				}			break;			case 'list' : show_dir($_GET['d']); /* Do il contenuto della cartella */ break;			case 'rnm' : if ($user['level'] <= $__privileges['explorer_rename']) rnm($_GET['f'],$_GET['n']); /* Rinomino un file */ break;			case 'mod' : 				if ($user['level'] <= $__privileges['explorer_edit']) {					include('_proto/editor.php');					//Modifica con l'editor assocciato al linguaggio					if (isset($_POST['f'])) { $f = $_POST['f'];	$t = $_POST['t']; $fi = fopen($_POST['f'],"w");	fwrite($fi,$_POST['edit']);	fclose($fi); $y = $_POST['edit']; } 					else { $y = stream_get_contents(fopen($_GET['f'],"r"));	$f = $_GET['f']; $t = $_GET['t']; }					echo "<script src='script.js'></script><script type='text/javascript' src='js/jquery.js'></script>		<script type='text/javascript' src='js/jquery-ui.js'></script><center><form action='admin_explorer.html' method='post'><input type='hidden' name='act' value='mod'><input type='hidden' name='t' value='$t'><input type='hidden' name='f' value='$f'><div style='width:760px;height:500px'>".get_editor('edit',$y,$t)."</div></form></center>";					exit(0);				}			break;			case 'mods' :				if ($user['level'] <= $__privileges['explorer_edit']) {					//Modifica con editor normale					if (isset($_POST['f'])) { $f = $_POST['f']; $fi = fopen($_POST['f'],"w");	fwrite($fi,$_POST['edit']);	fclose($fi); $y = $_POST['edit']; } 					else { $y = stream_get_contents(fopen($_GET['f'],"r"));	$f = $_GET['f']; }					echo "<script src='script.js'></script><center><form action='admin_explorer.html' method='post'><input type='hidden' name='act' value='mods'><input type='hidden' name='f' value='$f'><div style='width:760px;height:500px'><textarea name='edit' style='width:100%;height:100%'>".htmlspecialchars($y)."</textarea></div><input type='submit'></form></center>";					exit(0);				}			break;			case 'move' : /* Sposto uno o più files */ if ($user['level'] <= $__privileges['explorer_move']) for ($i=0;$i<count($_GET['f']);$i++) safe_rename($_GET['f'][$i],str_replace($_GET['d'].'/',$_GET['to'].'/',$_GET['f'][$i])); exit(0);	break;			case 'copy' : /* Copio uno o più files */ if ($user['level'] <= $__privileges['explorer_copy']) for ($i=0;$i<count($_GET['f']);$i++) safe_copy($_GET['f'][$i],str_replace($_GET['d'].'/',$_GET['to'].'/',$_GET['f'][$i])); exit(0); break;			case 'newf' : /* Nuovo file */ if ($user['level'] <= $__privileges['explorer_new_file']) if(!file_exists($_GET['f'])) {fclose(fopen($_GET['f'],"w")); echo ' { "s" : "y"} ';} else echo ' { "s" : "n"} '; exit(0); break;			case 'down' : /* Download di un file */if ($user['level'] <= $__privileges['explorer_download']) download_file($_GET['f']); break;			case 'zip' : //Compressione di uno o più files				if ($user['level'] <= $__privileges['explorer_zip']) {					include('_proto/pclzip.lib.php');							$archive = new PclZip($_GET['zn']);					if ($archive->create(implode(',',$_GET['f']),PCLZIP_OPT_REMOVE_PATH, dirname($_GET['f'][0])) == 0) echo ' { "s" : "y"} '; else echo ' { "s" : "n"} '; exit(0); 				}			break;			case 'uzip' : //Estrazione di un'archivio				if ($user['level'] <= $__privileges['explorer_zip']) {					include('_proto/pclzip.lib.php');					$archive = new PclZip($_GET['f']);					if ($archive->extract(PCLZIP_OPT_PATH, $_GET['d']) == 0) echo ' { "s" : "y"} '; else echo ' { "s" : "n"} '; exit(0); 				}			break;		}	elseif (isset($_GET['show_first'])) {		//Interfaccia del file explorer		echo '<div id="listmenu" class="popupmenu" onmouseover="pmenu.overpopupmenu(true);" onmouseout="pmenu.overpopupmenu(false);"><table cellspacing=0 cellpadding=0>';		if ($user['level'] <= $__privileges['explorer_download']) 			echo '<tr id="popdown" onclick="download()"><td><a class="imgdownload"></a>'.$__download.'</td></tr>';		if ($user['level'] <= $__privileges['explorer_edit'])			echo '<tr onclick="open_editor()" id="popedit"><td><a class="imgedit"></a>'.$__editor.'</td></tr><tr id="popeditc" onclick="open_editorm()"><td><a class="imgedita"></a>'.$__editorc.'</td></tr>';		echo '<tr><td><hr></td></tr>';		if ($user['level'] <= $__privileges['explorer_zip'])			echo '<tr id="popezip" onclick="unzip()"></td><td><a class="imgezip"></a>'.$__unzip.'</td></tr><tr id="popizip" onclick="zip()"><td><a class="imgizip"></a>'.$__zip.'</td></tr>';		echo '<tr><td><hr></td></tr>';		if ($user['level'] <= $__privileges['explorer_move'])			echo '<tr id="popmove" onclick="mvcpf(true)"><td><a class="imgmove"></a>'.$__move.'</td></tr>';		if ($user['level'] <= $__privileges['explorer_copy'])			echo '<tr id="popcopy" onclick="mvcpf(false)"><td><a class="imgcopy"></a>'.$__copy.'</td></tr>';		if ($user['level'] <= $__privileges['explorer_chmod'])			echo '<tr id="popchm"onclick="chmod()"><td style="padding-left: 20px;" >'.$__ch.'</td></tr>';		echo '<tr><td><hr></td></tr>';		if ($user['level'] <= $__privileges['explorer_del'])			echo '<tr onclick="del_file()"><td><a class="imgdel"></a>'.$__delete.'</td></tr>';		echo '</table></div><div class="ajaxwindow" style="width:640px;height:480px;margin-left:-320px;margin-top:-240px" id="mywindow"><div class="sub"><iframe width="640" height="480" name="winiframe" id="winiframe" src="" frameborder="0" border="0" ></iframe></div><a href="#" onclick="close_win()" class="closebutton"></a></div><div id="selection" style="border:1px dotted blue; z-index:999; position : fixed; display : none;"></div><div class="explorer"><div class="toolbar"><a class="imgdup hint" title="'.$__d_dup.'" href="javascript:dir_up()"></a><a class="imglmod hint" title="'.$__d_pre.'" href="javascript:showcmod()"></a>';		if ($user["level"] <= $__privileges["explorer_new_file"])			echo '<a class="imgnfile hint" title="'.$__d_nf.'" href="javascript:new_file()"></a>';		if ($user["level"] <= $__privileges["explorer_new_dir"])			echo '<a class="imgndir hint" title="'.$__d_nd.'" href="javascript:new_dir()"></a>';		if ($user["level"] <= $__privileges["explorer_upload"])			echo '<a class="imgupl hint" title="'.$__d_up.'" href="javascript:upload()"></a>';		if ($user["level"] <= $__privileges["explorer_chmod"])			echo '<a class="imgshell hint" title="'.$__d_sh.'" href="javascript:shell()"></a>';		echo '<div id="icmod" class="cmod"><table><tr><td><a class="sa" href="javascript:cmod("list")">'.$__list.'</a><tr><td><a class="sa" href="javascript:cmod("detail")">'.$__detail.'</a><tr><td><a class="sa" href="javascript:cmod("prev")">'.$__preview.'</a></table></div></div><ol class="detail hint" title="'.$__d_help.'" id="view"></ol><br><br><br><br><br><br><br><br><br><br><br><br><br></div><style>body {	-moz-user-select:none;    -webkit-user-select:none;}</style><script>var cdir = ".";var mode = "detail";var timer;var filesum = curfile = tyfile = tfile = ""var l__name = "<?php echo$__name?> : ";var	l__dir = "<?php echo$__dir ?> : ";var l__zipn = "<?php echo$__zipn ?> : ";var	drag=false;var	sx=ex=sy=ey=oxx=osx=oyy=osy=0;var selected;var to_elab="";var popupfilety=popupfilet=popupfile="";var rnm=true;show_dir(".");setTimeout(\'show_dir("");\',10000);pmenu = new PopupMenu("listmenu");document.getElementById("view").onmousemove = dragmove;document.getElementById("view").onmousedown = mouse_down;';		if ($tooltips) echo 'make_tooltip();';		echo '</script>';	} else header('Location: admin.html?open=explorer');}?>